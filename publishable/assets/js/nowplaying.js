let e={settings:""},r=!1,g=!1;function x(t){switch(t){case"playing":console.log("-- PLEX STARTED NOW PLAYING"),r=!0,P();break;case"paused":case"stopped":console.log("-- PLEX STOPPED NOW PLAYING"),r=!1,axios.post("/api/stopped",{service:"dmp-plex"});break}}function P(){const t=e.settings.plexUseSsl?"https":"http",p=t+"://"+e.settings.plexIpAddress+":32400",l="?X-Plex-Token="+e.settings.plexToken;axios.get(p+"/status/sessions/"+l).then(s=>{if(s.data.MediaContainer.size>0){let a=s.data.MediaContainer.Metadata[0],o={mediaType:"movie",contentRating:0,audienceRating:0,duration:null,poster:""},c=a.type==="show"||a.type==="episode"?s.data.MediaContainer.Metadata[0].grandparentThumb:s.data.MediaContainer.Metadata[0].thumb;o.poster=t+"://"+e.settings.plexIpAddress+":32400"+c+"?X-Plex-Token="+e.settings.plexToken,o.contentRating=a.contentRating,a.audienceRating&&(o.audienceRating=a.audienceRating),a.duration&&(o.duration=a.duration/1e3/60),axios.post("/api/now-playing",o).then(n=>{console.log(n)}).catch(n=>{console.log("PLEX NOW PLAYING ERROR: ",n.message)})}}).catch(s=>{console.log(s.message)})}function T(){const t=new WebSocket("ws://"+e.settings.plexIpAddress+":32400/:/websockets/notifications?X-Plex-Token="+e.settings.plexToken);t.addEventListener("open",()=>{}),t.addEventListener("message",p=>{const l=JSON.parse(p.data),s=l.NotificationContainer.type;let i;if(console.log("PLEX ACTION: ",s),s==="playing"&&(i=l.NotificationContainer.PlaySessionStateNotification[0].state,console.log("PLEX STATE: ",i),!g)){console.log("PLEX CHECK SESSION TYPE");const o=(e.settings.plexUseSsl?"https":"http")+"://"+e.settings.plexIpAddress+":32400",c="?X-Plex-Token="+e.settings.plexToken;axios.get(o+"/status/sessions/"+c).then(n=>{if(console.log(n),n.data.MediaContainer.size>0){let d=n.data.MediaContainer.Metadata[0];g=!0,(d.type==="movie"&&e.settings.plexShowMovieNowPlaying||(d.type==="show"||d.type==="episode")&&e.settings.plexShowTvNowPlaying)&&x(i)}}).catch(()=>{})}i==="stopped"&&r&&(g=!1,x(i))})}setTimeout(()=>{axios.get("/api/dmp-plex/settings").then(t=>{e.settings=t.data.settings,T()}).catch(t=>{console.log("ERROR GETTING PLEX NOW PLAYING SETTINGS: "+t.message)})},5e3);
